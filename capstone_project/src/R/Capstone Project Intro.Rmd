---
title: "Capstone Project - Global Destination Cities Index Mastercard"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
library(tidyverse)
library(stringr)
library(tabulizer)
library(ggthemes)
library(extrafont)
library(animation)
library(lubridate)
library(ggjoy)

loadfonts()


airBColor<- '#ff5a5f'
airBColor2<- '#008489'
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).


```{r}

header.true <- function(df) {
  names(df) <- as.character(unlist(df[1,]))
  colnames(df) <- make.names(colnames(df))
  df[-1,]
  }

extract_table_from_master_pdf <- function(){
    tab1 <- extract_tables("data/FINAL-Global-Destination-Cities-Index-Report.pdf", pages = 62)
    tab2 <- extract_tables("data/FINAL-Global-Destination-Cities-Index-Report.pdf", pages = 63)
    df_tab1<- tab1[[1]]
    df_tab2<- tab2[[1]]
    
    df_tab1a<-df_tab1[,c(1:5)]
    df_tab1b<-df_tab1[,c(7:11)][-1, ] 
    
    df_tab2a<-df_tab2[,c(1:5)]
    df_tab2b<-df_tab2[,c(7:11)][-1, ] 
    
    df_tab1<- rbind(df_tab1a,df_tab1b)
    df_tab2<- rbind(df_tab2a,df_tab2b)
    
    
    df_tab1<-header.true(as.data.frame(df_tab1))
    df_tab2<-header.true(as.data.frame(df_tab2))
    
    df_tab<-rbind(df_tab1,df_tab2) 
    
    write.csv(df_tab,'data/tmp/df_tab.csv') #otherwise the format is all factors.
    
  df_destination_overall<-read.csv('data/tmp/df_tab.csv',stringsAsFactors = FALSE) # recongize automatically numeric
  df_destination_overall<-df_destination_overall%>% select(-one_of(c('X.1','X')))
  df_destination_overall$Int.l.Overnight.Visitor.Spend<-gsub( "\\$", "",df_destination_overall$Int.l.Overnight.Visitor.Spend,)
  df_destination_overall$Int.l.Overnight.Visitor.Spend<-as.numeric(df_destination_overall$Int.l.Overnight.Visitor.Spend )
  str(df_destination_overall)
  write.csv(df_destination_overall,'data/global_destination_index_overall.csv')
}


```

# Master Card Plot
```{r}
#extract_table_from_master_pdf()

df_destination_overall<- read.csv('data/global_destination_index_overall.csv',stringsAsFactors = FALSE)
```

```{r}
pdf("capital_report_master_card.pdf", width=8,height=8)

european_airbnb_cities<-c("Athens","Amsterdam","Barcelona","Berlin","Dublin","London","Paris","Madrid","Rome","Lagos",
                          "Vienna")
ggplot(df_destination_overall,aes(x=Int.l.Overnight.Visitor.Spend,y=Int.l.Overnight.Visitors,label=Destination))+ geom_point(colour=airBColor,size=.75,alpha=1)  +
  geom_text(aes(label=ifelse((Destination %in% european_airbnb_cities)|(Int.l.Overnight.Visitor.Spend>10) &(Destination!="Kuala Lumpur"),as.character(Destination),'')),hjust=-.25, vjust=0.25,size=3,family="Helvetica" )+
  theme(text = element_text(size=12, family="CM Roman"))+labs(x='Total spending overnight visitors (US$ billions)',y='Total overnight visitors (millions)')+ stat_smooth(method="lm", se=FALSE,color=airBColor2,linetype="dotted", size=.5)+ xlim(0, 32)+ylim(0,22)

dev.off()

# Embed the fonts
embed_fonts("capital_report_master_card.pdf", outfile="capital_report_master_card_embed.pdf")
im.convert("capital_report_master_card_embed.pdf", output = "report/img/capital_report_master_card_embed.png", extra.opts="-density 600")

```
# Benchmark AirBnB Cities
```{r}
df<-read.csv('data/benchmark_capitals/all_listings.csv',stringsAsFactors = FALSE)
df<- df %>% mutate_at(c('host_since','first_review','last_review'), funs(new_=ymd(.)))
head(df)
dim(df)

df.profi<-df %>% filter((availability_30>0)&(availability_30<25)&(price<200))
df.profi.appart<-df.profi %>% filter(room_type=="Entire home/apt")

```


```{r}
pdf("./report/img/city_benchmark_availability_30.pdf", width=8,height=8)

ggplot(df.profi.appart,aes(x=availability_30,y=city))+ geom_joy(fill = airBColor)+theme(text = element_text(size=12, family="CM Roman"))+labs(x='Nights available next 30 days')

dev.off()

# Embed the fonts
embed_fonts("./report/img/city_benchmark_availability_30.pdf", outfile="./report/img/city_benchmark_availability_30_embed.pdf")
im.convert("./report/img/city_benchmark_availability_30_embed.pdf", output = "./report/img/city_benchmark_availability_30_embed.png", extra.opts="-density 600")
```

```{r}
pdf("city_benchmark_price.pdf", width=8,height=8)

ggplot(df.profi.appart,aes(x=price,y=city))+ geom_joy(fill = airBColor2)+theme(text = element_text(size=12, family="CM Roman"))+labs(x='Price per night($)')

dev.off()

# Embed the fonts
embed_fonts("city_benchmark_price.pdf", outfile="city_benchmark_price_embed.pdf")
im.convert("city_benchmark_price_embed.pdf", output = "report/img/city_benchmark_price_embed.png", extra.opts="-density 600")
```
## Group by room_type

```{r}

pdf("city_benchmark_room_type.pdf", width=8,height=8)
g <- ggplot(df.profi, aes(city))
g+ geom_bar(aes(fill = room_type))+ coord_flip() +scale_fill_manual("legend", values = c("Entire home/apt" = airBColor, "Private room" = airBColor2,"Shared room" = "grey"))+theme(text = element_text(size=12, family="CM Roman"),legend.title=element_blank(),axis.title.y=element_blank())+labs(y=' ')

dev.off()

# Embed the fonts
embed_fonts("city_benchmark_room_type.pdf", outfile="city_benchmark_room_type_embed.pdf")
im.convert("city_benchmark_room_type_embed.pdf", output = "report/img/city_benchmark_room_type_embed.png", extra.opts="-density 600")
```

