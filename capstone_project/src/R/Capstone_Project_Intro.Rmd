---
title: "Capstone Project - Global Destination Cities Index Mastercard"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
library(tidyverse)
library(stringr)
library(tabulizer)
library(ggthemes)
library(extrafont)
library(animation)
library(lubridate)
library(ggjoy)

loadfonts()


airBColor<- '#ff5a5f'
airBColor2<- '#008489'
```
```{r}
get_path_var<- function(filename){
 path<-''
  path$pdf <- paste('../../report/img/',filename,'.pdf',sep='')
  path$embed<- paste('../../report/img/',filename,'_embed.pdf',sep='')
  path$png<- paste(filename,'.png',sep='')
  return (path)
}

save_to_png <- function(path){
    #Embed the fonts
  embed_fonts(path$pdf, outfile=path$embed)
  im.convert(path$embed, output = path$png, extra.opts="-density 600")
  file.rename(path$png,paste('../../report/img/',path$png,sep=''))
  file.remove(path$pdf)
  file.remove(path$embed)
}
```


# Master Card Plot
```{r}
#extract_table_from_master_pdf()

df_destination_overall<- read.csv('../../data/global_destination_index_overall.csv',stringsAsFactors = FALSE)
```

```{r}
path <- get_path_var('capital_report_master_card')
pdf(path$pdf, width=8,height=8)

european_airbnb_cities<-c("Athens","Amsterdam","Barcelona","Berlin","Dublin","London","Paris","Madrid","Rome","Lagos",
                          "Vienna")
ggplot(df_destination_overall,aes(x=Int.l.Overnight.Visitor.Spend,y=Int.l.Overnight.Visitors,label=Destination))+ geom_point(colour=airBColor,size=.75,alpha=1)  +
  geom_text(aes(label=ifelse((Destination %in% european_airbnb_cities)|(Int.l.Overnight.Visitor.Spend>10) &(Destination!="Kuala Lumpur"),as.character(Destination),'')),hjust=-.25, vjust=0.25,size=3,family="Helvetica" )+
  theme(text = element_text(size=14, family="CM Roman"))+labs(x='Total spending overnight visitors (US$ billions)',y='Total overnight visitors (millions)')+ stat_smooth(method="lm", se=FALSE,color=airBColor2,linetype="dotted", size=.5)+ xlim(0, 32)+ylim(0,22)

dev.off()
save_to_png(path)
```
# Benchmark AirBnB Cities
```{r}
df<-read.csv('../../data/benchmark_capitals/all_listings.csv',stringsAsFactors = FALSE)
df<- df %>% mutate_at(c('host_since','first_review','last_review'), funs(new_=ymd(.)))
head(df)
dim(df)

df.profi<-df %>% filter((availability_30>0)&(availability_30<25)&(price<200))
df.profi.appart<-df.profi %>% filter(room_type=="Entire home/apt")

```


```{r}
path <- get_path_var('city_benchmark_availability_30')
pdf(path$pdf, width=8,height=8)

ggplot(df.profi.appart,aes(x=availability_30,y=city))+ geom_joy(fill = airBColor)+theme(text = element_text(size=14, family="CM Roman"))+labs(x='Nights available next 30 days')

dev.off()
save_to_png(path)
```

```{r}
path <- get_path_var('city_benchmark_price')
pdf(path$pdf, width=8,height=8)
ggplot(df.profi.appart,aes(x=price,y=city))+ geom_joy(fill = airBColor2)+theme(text = element_text(size=14, family="CM Roman"))+labs(x='Price per night($)')

dev.off()
save_to_png(path)
```
## Group by room_type

```{r}
path <- get_path_var('city_benchmark_room_type')
pdf(path$pdf, width=8,height=8)
g <- ggplot(df.profi, aes(city))
g+ geom_bar(aes(fill = room_type))+ coord_flip() +scale_fill_manual("legend", values = c("Entire home/apt" = airBColor, "Private room" = airBColor2,"Shared room" = "grey"))+theme(text = element_text(size=14, family="CM Roman"),legend.title=element_blank(),axis.title.y=element_blank())+labs(y=' ')

dev.off()
save_to_png(path)
```


# Group by host listing counts
```{r}
df.listing<- read.csv('../../data/listing_for_EDA.csv',stringsAsFactors = FALSE)
```

```{r}
path <- get_path_var('host_listing_counts_reviews')
pdf(path$pdf, width=8,height=8)

df.listing<- df.listing %>% filter((host_listings_count<10)&(host_listings_count>0)&(availability_30>0)&(availability_30<27))
ggplot(df.listing ,aes(x=as.factor(host_listings_count),y=reviews_per_month,group=host_listings_count))+ geom_boxplot(fill=airBColor)+theme(text = element_text(size=14, family="CM Roman"),legend.title=element_blank())+labs(x='listings per host',y='number of reviews per month')

dev.off()
save_to_png(path)

```


```{r}
path <- get_path_var('host_listing_availability_30')
pdf(path$pdf, width=8,height=8)

df.listing<- df.listing %>% filter((host_listings_count<10)&(host_listings_count>0)&(availability_30>0)&(availability_30<27))
ggplot(df.listing ,aes(x=as.factor(host_listings_count),y=availability_30,group=host_listings_count))+ geom_boxplot(fill=airBColor)+theme(text = element_text(size=14, family="CM Roman"),legend.title=element_blank())+labs(x='listings per host',y='Availability next 30 days')

dev.off()
save_to_png(path)

```

```{r}
path <- get_path_var('listing_counts')
pdf(path$pdf, width=8,height=8)

df.listing<- df.listing %>% filter((host_listings_count<20)&(host_listings_count>0)&(availability_30>0)&(availability_30<27))
g <- ggplot(df.listing, aes(as.factor(host_listings_count)))
g+ geom_bar(fill=airBColor)+theme(text = element_text(size=14, family="CM Roman"),legend.title=element_blank())+labs(x='listings own by host',y='total listings')

dev.off()
save_to_png(path)
```

## Distributioon of missing features
```{r}
df.listing.raw<-read.csv('../../data/insideAirBnB/listings.csv',stringsAsFactors = FALSE)
df.missing.values <- as.data.frame(colMeans(is.na(df.listing.raw)))
df.missing.values<-tibble::rownames_to_column(data.frame(df.missing.values),'feature')
colnames(df.missing.values)<-c('Features','percent.missing')


path <- get_path_var('missing_values')
pdf(path$pdf, width=8,height=8)

ggplot(df.missing.values,aes(x=percent.missing*100)) + geom_histogram()+theme(text = element_text(size=14, family="CM Roman"),legend.title=element_blank())+labs(x='% values missing',y='number of features')
dev.off()
save_to_png(path)



```

```{r}

path <- get_path_var('missing_features')
pdf(path$pdf, width=8,height=8)



g <- ggplot(df.listing, aes(as.factor(host_listings_count)))
g+ geom_bar(fill=airBColor)+theme(text = element_text(size=14, family="CM Roman"),legend.title=element_blank())+labs(x='listings own by host',y='total listings')

dev.off()
save_to_png(path)
```

